var BASE_URL = localStorageGetItem("baseUrl") || "https://api.judge0.com";
var SUBMISSION_CHECK_TIMEOUT = 10; // in ms
var WAIT = localStorageGetItem("wait") == "true";

var sourceEditor;
var $selectLanguageBtn, $runBtn, $vimCheckBox;
var $statusLine, $emptyIndicator;
var timeStart, timeEnd;

function encode(str) {
  return btoa(unescape(encodeURIComponent(str)));
}

function decode(bytes) {
  var escaped = escape(atob(bytes));
  try {
    return decodeURIComponent(escaped);
  } catch(error) {
    return unescape(escaped);
  }
}

function getIdFromURI() {
  return location.search.substr(1).trim();
}

function handleError(jqXHR, textStatus, errorThrown) {
  $statusLine.html('${jqXHR.statusText} (${jqXHR.status})');
}

function handleRunError(jqXHR, textStatus, errorThrown) {
  handleError(jqXHR, textStatus, errorThrown);
  $runBtn.button("reset");
  updateEmptyIndicator();
}

function handleResult(data) {
  timeEnd = performance.now();
  console.log("It took " + (timeEnd - timeStart) + " ms to get submission result.");

  var status = data.status;
  var stdout = decode(data.stdout || "");
  var stderr = decode(data.stderr || "");
  var compile_output = decode(data.compile_output || "");
  var message = decode(data.message || "");
  var time = (data.time === null ? "-" : data.time + "s");
  var memory = (data.memory === null ? "-" : data.memory + "KB");

  $statusLine.html('${status.description}, ${time}, ${memory}');

  if (status.id == 6) {
    stdout = compile_output;
  } else if (status.id == 13) {
    stdout = message;
  } else if (status.id != 3 && stderr != "") { // If status is not "Accepted", merge stdout and stderr
    stdout += (stdout == "" ? "" : "\n") + stderr;
  }

  updateEmptyIndicator();
  $runBtn.button("reset");
}

function toggleVim() {
  var keyMap = vimCheckBox.checked ? "vim" : "default";
  localStorageSetItem("keyMap", keyMap);
  sourceEditor.setOption("keyMap", keyMap);
  focusAndSetCursorAtTheEnd();
}

function run() {
  if (sourceEditor.getValue().trim() == "") {
    alert("Source code can't be empty.");
    return;
  } else {
    $runBtn.button("loading");
  }

  var sourceValue = encode(sourceEditor.getValue());
  var languageId = $selectLanguageBtn.val();
  var data = {
    source_code: sourceValue,
    language_id: languageId
  };

  timeStart = performance.now();
  $.ajax({
    url: BASE_URL + '/submissions?base64_encoded=true&wait=${WAIT}',
    type: "POST",
    async: true,
    contentType: "application/json",
    data: JSON.stringify(data),
    success: function(data, textStatus, jqXHR) {
      console.log('Your submission token is: ${data.token}');
      if (WAIT == true) {
        handleResult(data);
      } else {
        setTimeout(fetchSubmission.bind(null, data.token), SUBMISSION_CHECK_TIMEOUT);
      }
    },
    error: handleRunError
  });
}

function fetchSubmission(submission_token) {
  $.ajax({
    url: BASE_URL + "/submissions/" + submission_token + "?base64_encoded=true",
    type: "GET",
    async: true,
    success: function(data, textStatus, jqXHR) {
      if (data.status.id <= 2) { // In Queue or Processing
        setTimeout(fetchSubmission.bind(null, submission_token), SUBMISSION_CHECK_TIMEOUT);
        return;
      }
      handleResult(data);
    },
    error: handleRunError
  });
}

function setEditorMode() {
  sourceEditor.setOption("mode", $selectLanguageBtn.find(":selected").attr("mode"));
}

function focusAndSetCursorAtTheEnd() {
  sourceEditor.focus();
  sourceEditor.setCursor(sourceEditor.lineCount(), 0);
}

function loadRandomLanguage() {
  var randomChildIndex = Math.floor(Math.random()*$selectLanguageBtn[0].length);
  $selectLanguageBtn[0][randomChildIndex].selected = true;
  setEditorMode();
}

function initializeElements() {
  $selectLanguageBtn = $("#selectLanguageBtn");
  $insertTemplateBtn = $("#insertTemplateBtn");
  $runBtn = $("#runBtn");
  $vimCheckBox = $("#vimCheckBox");
  $emptyIndicator = $("#emptyIndicator");
  $statusLine = $("#statusLine");
}

function localStorageSetItem(key, value) {
  try {
    localStorage.setItem(key, value);
  } catch (ignorable) {
  }
}

function localStorageGetItem(key) {
  try {
    return localStorage.getItem(key);
  } catch (ignorable) {
    return null;
  }
}

$(document).ready(function() {
  console.log("Hey, Judge0 IDE is open-sourced: https://github.com/judge0/ide. Have fun!");

  initializeElements();

  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  });

  sourceEditor = CodeMirror(document.getElementById("sourceEditor"), {
    lineNumbers: true,
    indentUnit: 4,
    indentWithTabs: true,
    showCursorWhenSelecting: true,
    matchBrackets: true,
    autoCloseBrackets: true,
    keyMap: localStorageGetItem("keyMap") || "default",
    extraKeys: {
      "Tab": function(cm) {
        var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
        cm.replaceSelection(spaces);
      }
    }
  });

  $vimCheckBox.prop("checked", localStorageGetItem("keyMap") == "vim").change();
  loadRandomLanguage();

  if (BASE_URL != "https://api.judge0.com") {
    $("#apiLink").attr("href", BASE_URL);
    $("#apiLink").html(BASE_URL);
  }

  $selectLanguageBtn.change(function(e) {
    if (sourceEditor.isClean()) {
      insertTemplate();
    }
    setEditorMode();
  });

  $insertTemplateBtn.click(function(e) {
    if (!sourceEditor.isClean() && confirm("Are you sure? Your current changes will be lost.")) {
      setEditorMode();
      insertTemplate();
    }
  });

  $("body").keydown(function(e){
    var keyCode = e.keyCode || e.which;
    if (keyCode == 120) { // F9
      e.preventDefault();
      run();
    } else if (keyCode == 119) { // F8
      e.preventDefault();
      var url = prompt("Enter URL of Judge0 API:", BASE_URL);
      if (url != null) {
        url = url.trim();
      }
      if (url != null && url != "") {
        BASE_URL = url;
        localStorageSetItem("baseUrl", BASE_URL);
        if (BASE_URL != "https://api.judge0.com") {
          $("#apiLink").attr("href", BASE_URL);
          $("#apiLink").html(BASE_URL);
        }
      }
    } else if (keyCode == 118) { // F7
      e.preventDefault();
      WAIT=!WAIT;
      localStorageSetItem("wait", WAIT);
      alert('Submission wait is ${WAIT ? "ON. Enjoy" : "OFF"}.');
    } 
  });

  $runBtn.click(function(e) {
	var submit = document.getElementById("source");
    document.getElementById("source").value = sourceEditor.getValue();
  });

  $vimCheckBox.change(function() {
    toggleVim();
  });

  $("#downloadSourceBtn").click(function(e) {
    var value = parseInt($selectLanguageBtn.val());
    download(sourceEditor.getValue(), fileNames[value], "text/plain");
  });

  $("#downloadInputBtn").click(function(e) {
    download(inputEditor.getValue(), "input.txt", "text/plain");
  });
});
